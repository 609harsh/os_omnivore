(()=>{"use strict";var e,t=new Uint8Array(16);function a(){if(!e&&!(e="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return e(t)}const n=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;for(var s=[],o=0;o<256;++o)s.push((o+256).toString(16).substr(1));const r=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase();if(!function(e){return"string"==typeof e&&n.test(e)}(a))throw TypeError("Stringified UUID is invalid");return a},i=function(e,t,n){var s=(e=e||{}).random||(e.rng||a)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){n=n||0;for(var o=0;o<16;++o)t[n+o]=s[o];return t}return r(s)};let d=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+((t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_")),"");const c="https://omnivore.app",u="https://api-prod.omnivore.app/api/";let l=[],p={};async function g(e,t){const a=JSON.stringify({query:"mutation UploadFileRequest($input: UploadFileRequestInput!) {\n      uploadFileRequest(input:$input) {\n        ... on UploadFileRequestError {\n          errorCodes\n        }\n        ... on UploadFileRequestSuccess {\n          id\n          createdPageId\n          uploadSignedUrl\n        }\n      }\n    }",variables:{input:{url:e,contentType:t,createPageEntry:!0}}}),n="uploadFileRequest",s=await gqlRequest(u+"graphql",a);if(!s[n].errorCodes)return s.uploadFileRequest;"UNAUTHORIZED"===s[n].errorCodes[0]?(browserApi.tabs.sendMessage(currentTab.id,{action:ACTIONS.UpdateStatus,payload:{target:"logged_out",status:"logged_out",message:"You are not logged in.",ctx:toolbarCtx}}),b()):browserApi.tabs.sendMessage(currentTab.id,{action:ACTIONS.UpdateStatus,payload:{status:"failure",message:"Unable to save page.",ctx:toolbarCtx}})}function b(){getStorageItem("postInstallClickComplete").then((e=>{e&&removeStorage("postInstallClickComplete")}))}async function I(e,t){const a=i();await f(e,SAVE_URL_QUERY,"saveUrl",{source:"extension",clientRequestId:a,url:encodeURI(t)})}async function f(e,t,a,n){const s={omnivoreURL:c,originalURL:n.url,requestId:n.clientRequestId};p[s.requestId]=void 0;const o=JSON.stringify({query:t,variables:{input:n}});browserApi.tabs.sendMessage(e.id,{action:ACTIONS.ShowToolbar,payload:{type:"loading",ctx:s}});try{const t=await gqlRequest(u+"graphql",o);if(t[a].errorCodes)return void("UNAUTHORIZED"===t[a].errorCodes[0]?(browserApi.tabs.sendMessage(e.id,{action:ACTIONS.UpdateStatus,payload:{target:"logged_out",status:"logged_out",message:"You are not logged in.",ctx:s}}),b()):browserApi.tabs.sendMessage(e.id,{action:ACTIONS.UpdateStatus,payload:{status:"failure",message:"Unable to save page.",ctx:s}}));const n=t[a]?t[a].url:void 0,r=t[a]?t[a].clientRequestId:void 0;browserApi.tabs.sendMessage(e.id,{action:ACTIONS.UpdateStatus,payload:{status:"success",target:"page",ctx:{readerURL:n,responseId:r,requestId:s.requestId}}}),p[s.requestId]={readerURL:n,responseId:r,requestId:s.requestId}}catch(e){console.log("error saving: ",e)}h(e.id)}function y(e,t,a,n){browserApi.tabs.sendMessage(e,{action:ACTIONS.UpdateStatus,payload:{target:t,status:a,message:n}})}async function h(e){l.filter((t=>t.tabId===e)).forEach((async t=>{let a=!1;const n=p[t.clientRequestId];if(n)switch(t.type){case"EDIT_TITLE":a=await async function(e,t,a){return updatePageTitle(u+"graphql",a.responseId,t.title).then((()=>(y(e,"title","success","Title updated."),!0))).catch((t=>(console.log("caught error updating title: ",t),y(e,"title","failure","Error updating title."),!0)))}(e,t,n);break;case"ADD_NOTE":a=await async function(e,t,a){const n=i(),s=d(8);return addNote(u+"graphql",a.responseId,n,s,t.note).then((()=>(y(e,"note","success","Note updated."),!0))).catch((t=>(console.log("caught error updating title: ",t),y(e,"note","failure","Error adding note."),!0)))}(e,t,n);break;case"SET_LABELS":a=await async function(e,t,a){return setLabels(u+"graphql",a.responseId,t.labelIds).then((()=>(y(e,"labels","success","Labels updated."),!0))).catch((()=>(y(e,"labels","failure","Error updating labels."),!0)))}(e,t,n);break;case"ARCHIVE":a=await async function(e,t,a){return archive(u+"graphql",a.responseId).then((()=>(y(e,"extra","success","Archived"),!0))).catch((()=>(y(e,"extra","failure","Error archiving"),!0)))}(e,0,n);break;case"DELETE":a=await async function(e,t,a){return deleteItem(u+"graphql",a.responseId).then((()=>(y(e,"extra","success","Deleted"),!0))).catch((()=>(y(e,"extra","failure","Error deleting"),!0)))}(e,0,n)}if(a){const e=l.findIndex((e=>t.id===e.id));e>-1&&l.splice(e,1)}}))}async function A(e){browserApi.tabs.sendMessage(e.id,{action:ACTIONS.GetContent},(async t=>{if(!t||"object"!=typeof t)return void await I(e,e.url);const a=i();var{type:n}=t;const{pageInfo:s,doc:o,uploadContentObjUrl:r}=t;switch("html"==n&&handleBackendUrl(e.url)&&(n="url"),n){case"html":await f(e,SAVE_PAGE_QUERY,"savePage",{source:"extension",clientRequestId:a,originalContent:o,title:s.title,url:encodeURI(e.url)});break;case"url":await f(e,SAVE_URL_QUERY,"saveUrl",{source:"extension",clientRequestId:a,url:encodeURI(e.url)});break;case"pdf":{const t=await async function(e,t,a,n,s){const o={omnivoreURL:c,originalURL:t,requestId:a};p[o.requestId]=void 0,browserApi.tabs.sendMessage(e.id,{action:ACTIONS.ShowToolbar,payload:{type:"loading",ctx:o}});const r=await g(t,n);console.log("done uploading pdf",r);const i=await function({id:e,uploadSignedUrl:t},a,n){return fetch(n).then((e=>e.blob())).then((e=>fetch(t,{method:"PUT",headers:{"Content-Type":a},body:e}))).catch((e=>{console.error("error uploading file",e)}))}(r,n,s);return console.log(" uploadFileResult: ",i),URL.revokeObjectURL(s),i&&r.createdPageId&&(p[o.requestId]={requestId:o.requestId,responseId:r.createdPageId},browserApi.tabs.sendMessage(e.id,{action:ACTIONS.UpdateStatus,payload:{status:"success",target:"page",ctx:{requestId:o.requestId,responseId:r.createdPageId}}})),i}(e,encodeURI(e.url),a,s.contentType,r);if(!t||!t.id)return void await f(e,SAVE_URL_QUERY,"saveUrl",{source:"extension",clientRequestId:a,url:encodeURI(e.url)});break}}}))}async function w(e){const t=await getStorageItem(e+"_saveInProgress");if(!t)return;clearInterval(t);const a=await getStorageItem(e+"_saveInProgressTimeoutId_"+t);a&&clearTimeout(a)}function S(e){return Promise.resolve(!0)}function v(e){new Promise((e=>{browserApi.tabs.query({active:!0,currentWindow:!0},(function(t){e(t[0]||null)}))})).then((t=>{browserApi.tabs.sendMessage(t.id,{action:ACTIONS.Ping},(async function(a){if(a&&a.pong)await S(t.id)&&e(t);else{const a=browserApi.runtime.getManifest().content_scripts,n=[...a[0].js,...a[1].js];!function(a,n,s){function o(e,t,a){return function(){browserScriptingApi.executeScript(e,t,a)}}let r=async function(){await S(t.id)&&e(t)};for(let e=n.length-1;e>=0;--e)r=o(a,{file:n[e]},r);null!==r&&r()}(t.id,n)}}))}))}function R(e,t){let a="/images/toolbar/icon";if(ENV_IS_FIREFOX?a+="_firefox":ENV_IS_EDGE&&(a+="_edge"),e||(a+="_inactive"),("boolean"==typeof t?t:window.matchMedia("(prefers-color-scheme: dark)").matches)&&(a+="_dark"),ENV_IS_FIREFOX)return a+".svg";const n=["16","24","32","48"];ENV_IS_EDGE||n.push("19","38");const s={};for(let e=0;e<n.length;e++){const t=n[e];s[t]=a+"-"+t+".png"}return s}function m(e,t,a){browserActionApi.setIcon({path:R(t,a),tabId:e})}function q(e){const t=e&&e.id;if(!t)return;const a=function(e){if("complete"!==e.status)return!1;const t=e.pendingUrl||e.url;return!(!t||!t.startsWith("https://")&&!t.startsWith("http://")||t.startsWith("https://omnivore.app/")&&t.startsWith("https://dev.omnivore.app/"))}(e);m(t,a)}browserApi.tabs.onActivated.addListener((({tabId:e})=>{!function t(){browserApi.tabs.get(e,(function(e){browserApi.runtime.lastError&&setTimeout(t,150),q(e)}))}()})),browserApi.tabs.onUpdated.addListener(((e,t,a)=>{t.status&&a&&a.active&&q(a)})),browserApi.tabs.onRemoved.addListener((e=>{!function(e){getStorage().then((function(t){const a=[],n=Object.keys(t),s=e+"_saveInProgress";for(let e=0;e<n.length;e++){const t=n[e];t.startsWith(s)&&a.push(t)}0!==a.length&&removeStorage(a)}))}(e)})),browserActionApi.onClicked.addListener((function(){v((function(e){!function(e){function t(t,a){browserApi.tabs.get(e,(async e=>{if("complete"!==e.status)browserApi.tabs.sendMessage(e.id,{action:ACTIONS.ShowMessage,payload:{type:"loading",text:"Page loading..."}}),a&&"function"==typeof a&&a();else{t&&"function"==typeof t&&t(),await A(e);try{await updateLabelsCache(u+"graphql",e),browserApi.tabs.sendMessage(e.id,{action:ACTIONS.LabelCacheUpdated,payload:{}})}catch(e){return void console.error("error fetching labels",e,u)}}}))}w(e),t(null,(()=>{!function(e,t,a,n=1e3,s=10500){const o=setInterval(e,n),r=setTimeout((()=>{clearInterval(o),t()}),s);a&&"function"==typeof a&&a(o,r)}((()=>{t((()=>{w(e)}))}),(()=>{w(e),browserApi.tabs.get(e,(async e=>{await A(e)}))}),((t,a)=>{const n={};n[e+"_saveInProgress"]=t,n[e+"_saveInProgressTimeoutId_"+t]=a,setStorage(n)}))}))}(e.id)}))})),browserApi.runtime.onMessage.addListener(((e,t,a)=>{if(e.forwardToTab)return delete e.forwardToTab,void browserApi.tabs.sendRequest(t.tab.id,e);e.action===ACTIONS.RefreshDarkMode&&m(t.tab.id,e.payload.value),e.action===ACTIONS.EditTitle&&(l.push({id:i(),type:"EDIT_TITLE",tabId:t.tab.id,title:e.payload.title,clientRequestId:e.payload.ctx.requestId}),h(t.tab.id)),e.action===ACTIONS.Archive&&(l.push({id:i(),type:"ARCHIVE",tabId:t.tab.id,clientRequestId:e.payload.ctx.requestId}),h(t.tab.id)),e.action===ACTIONS.Delete&&(l.push({type:"DELETE",tabId:t.tab.id,clientRequestId:e.payload.ctx.requestId}),h(t.tab.id)),e.action===ACTIONS.AddNote&&(l.push({id:i(),type:"ADD_NOTE",tabId:t.tab.id,note:e.payload.note,clientRequestId:e.payload.ctx.requestId}),h(t.tab.id)),e.action===ACTIONS.SetLabels&&(l.push({id:i(),type:"SET_LABELS",tabId:t.tab.id,labelIds:e.payload.labelIds,clientRequestId:e.payload.ctx.requestId}),h(t.tab.id))})),browserActionApi.setIcon({path:R(!0)}),browserApi.contextMenus.create({id:"save-selection",title:"Save to Omnivore",contexts:["link"],onclick:async function(e){v((async function(t){await I(t,e.linkUrl)}))}})})();